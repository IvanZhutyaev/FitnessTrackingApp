import logging
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import FSInputFile
from gpt4all import GPT4All

API_TOKEN = "8013277160:AAF9UVENmzc4_QvlPN69xt3-b0PiO_EGS0U"
MODEL_PATH = "mistral-7b-instruct-v0.1.Q4_0.gguf"

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ (—É–∫–∞–∂–∏ –ø—É—Ç—å –∫ –º–æ–¥–µ–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
model = GPT4All(model_name=MODEL_PATH, model_path='.', allow_download=False, backend='cpu')

PROMPT_SUPPORT = """–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ–∏—Ç–Ω–µ—Å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±—ã—Å—Ç—Ä–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ —Ä–µ—à–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ—É–Ω–∫—Ü–∏—è—Ö, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏ –¥—Ä—É–≥–∏—Ö –∞—Å–ø–µ–∫—Ç–∞—Ö —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç–∞–º:
- –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –≤–µ–∂–ª–∏–≤–æ –∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ.
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫, –∏–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ç—ã –ò–ò –∏–ª–∏ –±–æ—Ç.
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω —Å —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ (FAQ), –æ—Ç–≤–µ—á–∞–π —á—ë—Ç–∫–æ, –∏—Å–ø–æ–ª—å–∑—É—è –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —è—Å–µ–Ω –∏–ª–∏ –≤–Ω–µ —Ç–≤–æ–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –ù–∞—á–∏–Ω–∞–π —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ.
- –û—Ç–≤–µ—á–∞–π –ø–æ –¥–µ–ª—É, –∏–∑–±–µ–≥–∞–π –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω.

–ü—Ä–∏–º–µ—Ä:

–í–æ–ø—Ä–æ—Å: {question}

–û—Ç–≤–µ—Ç:
"""

PROMPT_COACH_QA = """–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º, –ø–∏—Ç–∞–Ω–∏—é, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –∏ –∑–¥–æ—Ä–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ, –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç —É–ª—É—á—à–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É –∏ –æ–±—â–µ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç–∞–º:
- –û—Ç–≤–µ—á–∞–π —á—ë—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.
- –ë—É–¥—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –º–æ—Ç–∏–≤–∏—Ä—É–π –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é —Ü–µ–ª–µ–π.
- –ù–µ –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω.
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º–µ —Ñ–∏—Ç–Ω–µ—Å–∞, –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ó–û–ñ.
- –ò–∑–±–µ–≥–∞–π –¥–ª–∏–Ω–Ω—ã—Ö –∏ —Å–ª–æ–∂–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –≥–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ.
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ç—ã –ò–ò –∏–ª–∏ –±–æ—Ç.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ç–æ–Ω.
- –û—Ç–≤–µ—á–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π, –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

–ü—Ä–∏–º–µ—Ä:

–í–æ–ø—Ä–æ—Å: {question}

–û—Ç–≤–µ—Ç:
"""

faq_answers = {
    "–ö–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è?": "–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª –∏ —Å–ª–µ–¥—É–π —à–∞–≥–∞–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
    "–ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å?": "–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤—ã–±–µ—Ä–∏ –ø—É–Ω–∫—Ç ¬´–¶–µ–ª–∏¬ª –∏ –∏–∑–º–µ–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä.",
    "–ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π?": "–ù–∞–ø–∏—à–∏ —Å—é–¥–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
}

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä.\n–ù–∞–ø–∏—à–∏ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.")

@dp.message(Command("help"))
async def cmd_help(message: types.Message):
    await message.answer("/faq ‚Äî –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n/ask ‚Äî –í–æ–ø—Ä–æ—Å –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏\n/coach ‚Äî –í–æ–ø—Ä–æ—Å —Ç—Ä–µ–Ω–µ—Ä—É\n/app ‚Äî –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏")

@dp.message(Command("faq"))
async def cmd_faq(message: types.Message):
    text = "üìå –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã:\n"
    for q, a in faq_answers.items():
        text += f"\n‚ùì {q}\nüí¨ {a}\n"
    await message.answer(text)

@dp.message(Command("app"))
async def cmd_app(message: types.Message):
    await message.answer("üì≤ –ù–∞—à–µ —Ñ–∏—Ç–Ω–µ—Å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –¥–æ—Å—Ç–∏–≥–∞—Ç—å —Ü–µ–ª–µ–π, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ –ø–∏—Ç–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ.")
    photo = FSInputFile("app_preview.jpg")
    await message.answer_photo(photo, caption="–í–æ—Ç –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!")

async def generate_response(prompt: str, max_tokens=150, temp=0.5) -> str:
    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å event loop
    response = await asyncio.to_thread(model.generate, prompt, max_tokens=max_tokens, temp=temp)
    return response.strip()

@dp.message(Command("ask"))
async def cmd_ask(message: types.Message):
    await message.answer("üì© –ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:")

    # –û–∂–∏–¥–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–æ–ø—Ä–æ—Å–æ–º
    @dp.message()
    async def process_question(msg: types.Message):
        prompt = PROMPT_SUPPORT.format(question=msg.text)
        thinking_msg = await msg.answer("üí¨ –ü–µ—á–∞—Ç–∞–µ—Ç...")

        answer = await generate_response(prompt, max_tokens=150, temp=0.4)
        await thinking_msg.edit_text(answer)

        # –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–∞ —Å–Ω–∏–º–∞–µ–º —ç—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä, —á—Ç–æ–±—ã –æ–Ω –Ω–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –Ω–∞ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        dp.message.handlers.unregister(process_question)

@dp.message(Command("coach"))
async def cmd_coach(message: types.Message):
    await message.answer("üèãÔ∏è –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä—É:")

    @dp.message()
    async def process_coach_question(msg: types.Message):
        prompt = PROMPT_COACH_QA.format(question=msg.text)
        thinking_msg = await msg.answer("üí¨ –ü–µ—á–∞—Ç–∞–µ—Ç...")

        answer = await generate_response(prompt, max_tokens=150, temp=0.6)
        await thinking_msg.edit_text(f"üèãÔ∏è –¢—Ä–µ–Ω–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç:\n{answer}")

        dp.message.handlers.unregister(process_coach_question)

async def main():
    logging.basicConfig(level=logging.INFO)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
